---
layout: post
title: "연관관계 매핑 (기초)"
categories: [ java, jpa ]
---


### 연관관계 매핑


#### 방향
테이블은 방향개념 없음
객체는 단방향이 두개가 모여서 양방향이 된 것임 


방향 : 단방향, 양방향
다중성 : 다대일(N:1), 일대다(1:N), 일대일(1:1), 다대다(N:M)
연관관계의 주인(Owner): 객체 양방향 연관관계는 관리 주인이 필요

단방향 연관관계
Team의 참조값을 그대로 
@ManyToOne
@JoinColumn(name="필드이름")


그럼 양방향 연관관계가 좋나??
객체는 단방향이 좋다네요.ㅎㅎ 왜일까요?

@OneToMany(mappedBy="team")


연관관계의 주인이 아닌 경우는 읽기만 가능.
연관관계의 주인은 외래 키가 있는 쪽.
다 쪽이 연관관계의 주인이 되면 된다.



객체 단방향 2개
테이블 FK 하나로 양방향


양방향 매핑시 가장 많이 하는 실수
양방향 매핑시 연관관계의 주인에게 값을 셋팅하지 않음


연관관계 편의 메소드
관계중 한쪽에만 권장
1에 넣을지 다에 넣을지 결정
양방향 매핑시 무한루프 조심 (StackOverflowError)
toString 또는 객체를 json으로 변환 할 때... 장애 발생

lombok에서 자동생성되는 toString은 사용하지 말자.
컨트롤러에는 Entity 자체를 반환하지 말자. 
Entity를 단순한 값만 들어있는 dto로 변환해서 반환하자.
Entity의 스펙 변화시 API 스펙이 바뀌는 일이 발생.

연관관계의 매핑 시 주인을 기준으로 단방향 매핑만 일단 매핑
양방향 매핑은 역방향으로 탐색할 일이 많은 경우에만
추후에 추가해도 됨... 테이블에는 변화가 없기때문에 필요한 경우 그때 그때 추가 하면 된다.

객체 입장에서 양방향 매핑은 이득되는게 별로 없다.

양방향 연관관계를 만드는 이유는?
개발 상의 편의
JPQL 작성시 양방향 연관관계를 가져야만 가능 한 경우가 있음.


### 다중성

###### 다대일 @ManyToOne


###### 일대다 @OneToMany

- 일대다 단방향
@OneToMany
@JoinColumn(name="조인되는 테이블에서 사용되는 외래키 이름")
가능은 하다. 그러나 권장하지 않음. 실무에서 잘 사용되지 않음.
차라리 다대일 양방향으로 관리하는게 나을 수 있음.
다쪽에서 정보를 저장하기 위해 Update문이 한번 더 발생

엔티티가 관리하는 외래 키가 다른 테이블에 있음
연관관계 관리를 위해 추가로 UPDATE SQL 실행
일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하자.


- 일대다 양방향
@ManyToOne
@JoinColumn(insertable=false, updatable=false)


###### 일대일 @OneToOne
- 주 테이블에 외래 키 단방향 (선호!!)
@OneToOne 
@JoinColumn("컬럼명")
(양방향 추가)
@OneToOne(mappedBy="ddd") 읽기 전용이 됨.

- 대상 테이블에 외래 키 단방향
지원 안되고 , 방법도 없어요
(양방향 관계에서는 지원)


주 테이블에 외래 키
• 주 객체가 대상 객체의 참조를 가지는 것 처럼
주 테이블에 외래 키를 두고 대상 테이블을 찾음
• 객체지향 개발자 선호
• JPA 매핑 편리
• 장점: 주 테이블만 조회해도 대상 테이블에 데이터가 있는지 확인 가능
• 단점: 값이 없으면 외래 키에 null 허용
• 대상 테이블에 외래 키
• 대상 테이블에 외래 키가 존재
• 전통적인 데이터베이스 개발자 선호
• 장점: 주 테이블과 대상 테이블을 일대일에서 일대다 관계로 변경할 때 테이블 구조 유지
• 단점: 프록시 기능의 한계로 지연 로딩으로 설정해도 항상 즉시 로딩됨(프록시는 뒤에서 설명)


###### 다대다 @ManyToMany - 실무에서 쓰면 안된답니다.

관계형 데이터베이스는 정규화된 테이블 2개로 다대다 관계를
표현할 수 없음
• 연결 테이블을 추가해서 일대다, 다대일 관계로 풀어내야함  

편리해 보이지만 실무에서 사용X
• 연결 테이블이 단순히 연결만 하고 끝나지 않음
• 주문시간, 수량 같은 데이터가 들어올 수 있음